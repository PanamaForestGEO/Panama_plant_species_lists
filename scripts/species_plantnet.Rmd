---
title: "species_plantnet"
author: "Paula Uzcategui"
date: "2026-02-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Merge Panama Biota BCI list and Panama woody plant list to create a BCI woody species list

```{r setup2, echo=TRUE, results="hide"}

# installing wcvp
#install.packages("remotes")
#library(remotes)
#remotes::install_github("matildabrown/rWCVP")
#rm(list=ls())

library("readxl")
library("writexl")
library("dplyr")
library(tidyr)
library("TNRS")
library("stringi")
library("stringr")
library(rWCVP)
library(rWCVPdata)
citation("rWCVPdata") # so according to this, this is using version 13.

# Load the names and distributions
wcvp_names <- rWCVPdata::wcvp_names 

panamabiotaWCVP_path <- "splists_mid/PanamaBiotaBCI_WCVP_2026-02-10.xlsx"

save_plantlists_dir = "splists_out/Plantnet species/"

lastwoody_path <-  "splists_out/PanamaSpCombined_2026-02-10.xlsx"

bci_angiosperms_path <- "splists_raw/Panamabiota/Downloaded_2026-02-04/Plants of Barro Colorado - eudicots, magnoliids, and basal angiosperms_1770221196.csv"
bci_ferns_path <- "splists_raw/Panamabiota/Downloaded_2026-02-04/Plants of Barro Colorado - ferns and allies_1770221067.csv"
bci_monocots_path <- "splists_raw/Panamabiota/Downloaded_2026-02-04/Plants of Barro Colorado - monocots_1770221178.csv"

panamabiotatrees <- "splists_raw/Panamabiota/Downloaded_2026-02-04/Complete Tree Species of Panama_1770221306.csv"
panamabiotalianas <- "splists_raw/Panamabiota/Downloaded_2026-02-04/CTFS Liana Atlas of Panama_1770221260.csv"

```

## Preparing the datasets


```{r prep, echo=TRUE, results="hide"}

lastwoody <- read_excel(lastwoody_path)
nrow(lastwoody)

bciangio <- read.csv(bci_angiosperms_path, sep = ",")
bciferns <- read.csv(bci_ferns_path, sep = ",")
bcimonocots <- read.csv(bci_monocots_path, sep = ",")

# This returns TRUE only if all three are exactly the same
all(colnames(bciangio) == colnames(bcimonocots)) && all(colnames(bcimonocots) == colnames(bciferns))

# merge all bci in just one list and keep the source.
bciangio$source <- "angio"
bciferns$source <- "ferns"
bcimonocots$source <- "monocots"

bcibiota <- bind_rows(bciangio, bciferns, bcimonocots)

nrow(bcibiota)

bcibiota %>% count(source, name = "species_count")

# Lets check consistency:

# Duplicated names 
# check for duplicate and address if needed

bindups <- bcibiota %>% group_by(ScientificName) %>% arrange(ScientificName) %>% filter(n()>1) %>% ungroup()
nrow(bindups)

```

## Match Panama Biota with WCVP names

```{r mergewcvp}
######################### PANMA BIOTA WCVP names ##################################

# Merging accepted names 
matchaccepted_names<- function(matcheswcvp){
  matcheswcvp %>% 
    left_join(wcvp_names %>% select(plant_name_id, genus, species, taxon_rank, family, primary_author, infraspecific_rank, infraspecies, lifeform_description, taxon_status),
              by=c("wcvp_accepted_id"="plant_name_id")) %>% 
    mutate(
      Accepted_name = case_when(
        is.na(species) | species == "" ~ genus,
        !is.na(infraspecies) & infraspecies != "" ~ paste(genus, species, infraspecific_rank, infraspecies),
        TRUE ~ paste(genus, species))
    ) %>%
    rename(
      Accepted_family= family,
      Accepted_name_rank = taxon_rank,
      Accepted_name_author = primary_author,
      Accepted_name_status = taxon_status,
      Accepted_name_genus = genus, 
      Accepted_name_species = species, 
      Accepted_name_infraspecific_rank = infraspecific_rank, 
      Accepted_name_infraspecies = infraspecies
    )
}


# Check for species names changes
if(file.exists(panamabiotaWCVP_path)){
 matchresult <- read_excel(panamabiotaWCVP_path)
} else{
  matchresult <-wcvp_match_names(bcibiota, wcvp_names, name_col="ScientificName")
  write_xlsx(matchresult, paste0("splists_mid/PanamaBiotaBCI_WCVP_",Sys.Date(),".xlsx"))
}


# All the species are still on the table
all(unique(matchresult$ScientificName) %in% unique(bcibiota$ScientificName))

# There can be multiple matches for one species, but only one is considered accepted
#sanity check of that
matchresult %>%
  group_by(ScientificName) %>%
  summarise(
    n_rows = n(),
    n_accepted = sum(wcvp_status == "Accepted", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_accepted > 1)

# If they have two accepted names its probably because they were registered twice. The two records have different ids
manyaccepted <- matchresult %>%
  group_by(ScientificName) %>%
  summarise(
    n_rows = n(),
    n_accepted = sum(wcvp_status == "Accepted", na.rm = TRUE),
    .groups = "drop"
  ) %>%
  filter(n_accepted > 1)

matchresult %>%
  filter(ScientificName %in% manyaccepted$ScientificName) %>%
  select(ScientificName, wcvp_name,wcvp_status, wcvp_accepted_id, wcvp_id)
  
# They  have two accepted names! I will stay with the original.
inc = matchresult$ScientificName %in% manyaccepted$ScientificName
if (any(inc, na.rm = TRUE)) {
  matchresult$wcvp_accepted_id[inc] <- matchresult$wcvp_id[inc]
}

# rules to keep 1 name per species:
# if there is only one record with the current name keep that.
# if there are more than one keep the one with wcvp_status = "Accepted"
matchresult_clean <- matchresult %>%
  mutate(
    status_priority = case_when(
      wcvp_status == "Accepted"     ~ 1,
      wcvp_status == "Synonym"      ~ 2,
      wcvp_status == "Illegitimate" ~ 3,
      wcvp_status == "Unplaced"     ~ 4,
      TRUE                          ~ 5
    )
  ) %>%
  group_by(ScientificName) %>%
  slice_min(status_priority, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(-status_priority)


# Now this should be TRUE.
nrow(matchresult_clean) == nrow(bcibiota) 
# All the species are still on the table
all(unique(matchresult_clean$ScientificName) %in% unique(bcibiota$ScientificName))

# sanity check one species per row
matchresult_clean %>%
  group_by(ScientificName) %>%
  summarise(
    n_rows = n(),
    .groups = "drop"
  ) %>%
  filter(n_rows > 1)

matchresult_clean <- matchaccepted_names(matchresult_clean)

# Now left join 
bcibiotawcvpplus <-   bcibiota %>%
  left_join(matchresult_clean %>% 
            select(ScientificName, wcvp_name, wcvp_authors,wcvp_rank, wcvp_status, 
                   Accepted_name, Accepted_family, Accepted_name_rank, Accepted_name_author, Accepted_name_status,
                   Accepted_name_genus,
                   Accepted_name_species, 
                   Accepted_name_infraspecific_rank, 
                   Accepted_name_infraspecies,
                   lifeform_description, match_similarity, match_edit_distance),
            by="ScientificName") %>%
  rename(
    Name_matched = wcvp_name,
    Name_matched_rank = wcvp_rank

  )


# Scientific name is current name
bcibiotawcvpplus <- bcibiotawcvpplus %>% rename(
  pbiota_name = ScientificName,
  pbiota_author = ScientificNameAuthorship,
  pbiota_family = Family
                            )

# in that case leave the Name-matched as the accepted_name 
inc <- bcibiotawcvpplus$Accepted_name=="" | is.na(bcibiotawcvpplus$Accepted_name)
if (any(inc, na.rm = TRUE)) {
  table(inc)
  
  bcibiotawcvpplus$Accepted_name[inc] <- bcibiotawcvpplus$Name_matched[inc]
  bcibiotawcvpplus$Accepted_name_rank[inc] <- bcibiotawcvpplus$Name_matched_rank[inc]
  bcibiotawcvpplus$Accepted_name_author[inc] <- ifelse(is.na(bcibiotawcvpplus$Accepted_name_author[inc]) & bcibiotawcvpplus$Accepted_name[inc] == bcibiotawcvpplus$pbiota_name[inc],
                                                       bcibiotawcvpplus$pbiota_author[inc],
                                                       bcibiotawcvpplus$Accepted_name_author[inc]
  )
}

# lets see the taxonomic status of the matches
bcibiotawcvpplus %>% 
  count(wcvp_status, name = "n")


```

## Fix synonims and errors:

```{r checkerrors, echo=TRUE, results="hide"}

# For now lets assume the original biotanmae is correct 
bcibiotawcvpplus <- bcibiotawcvpplus %>% mutate(
  currwcvp_name = pbiota_name,
  currwcvp_family = pbiota_family,
  currwcvp_genus = word(pbiota_name, 1),
  currwcvp_species = word(pbiota_name, 2),
  currwcvp_subspecies = NA,
  currwcvp_author = pbiota_author,
  currpbiotachanged = FALSE,
  currnotes = "",
  synonyms = ""
)

bcibiotawcvpplus <- bcibiotawcvpplus %>% 
  mutate(
    pbiota_family = str_to_sentence(pbiota_family),
    currwcvp_family = str_to_sentence(currwcvp_family)
    )

```

### Case when no accepted name was found
```{r noaccepted}

species_na_wcvp <- bcibiotawcvpplus %>% filter(is.na(wcvp_status))

if(nrow(species_na_wcvp)>0){
  knitr::kable(species_na_wcvp %>% select( pbiota_name, Name_matched, wcvp_status))
}

```

## Case when the Family changed

```{r familychange}

familychanged <-  bcibiotawcvpplus %>% filter( pbiota_name == Accepted_name & currwcvp_family != Accepted_family &  wcvp_status == "Accepted") 

paste0("Species with changes in family ",  nrow(familychanged))

if( nrow(familychanged) > 0){
  knitr::kable(familychanged %>%  select(pbiota_family, Accepted_family, pbiota_name, Accepted_name, wcvp_status, currnotes), caption="Species with changes in family")
}

```


```{r familyfix}
# set family to the accepted family:
inc <- with(bcibiotawcvpplus,(
        (!is.na(pbiota_name) & !is.na(Accepted_name) &  pbiota_name == Accepted_name &   wcvp_status == "Accepted" & pbiota_name %in% familychanged$pbiota_name)))

species_modified4 <- bcibiotawcvpplus[inc,]

# Change the species family name
if (any(inc, na.rm=TRUE)) {
  
  tmp <- bcibiotawcvpplus[inc, ]
  
  # Perform calculations on the subset
  tmp$currpbiotachanged <- TRUE
  tmp$currwcvp_family     <- ifelse(!is.na(tmp$Accepted_family), tmp$Accepted_family, tmp$currwcvp_family)
  tmp$currnotes            <-  "Family changed in wcvp"
  
  # Re-assign the modified subset back to the original rows
  bcibiotawcvpplus[inc, ] <- tmp
}

#sanity check: a single genus always has the same family:
genus_many_families <- bcibiotawcvpplus %>%
  group_by(currwcvp_name) %>%
  summarise(n_families = n_distinct(currwcvp_family), .groups = "drop") %>%
  filter(n_families > 1)


if( nrow(genus_many_families) > 0){
  knitr::kable(genus_many_families %>%  select(currwcvp_name, n_families), caption="Sanity check: genus with more than one family")
}
```


### Case when species name spelling changed

```{r spellingerror}
# Matching errors should be only on typos or spelling errors:
# subspecies and hybrids are common errors. 
matchingerrors <- bcibiotawcvpplus %>%
  filter((is.na(Name_matched) | pbiota_name !=Name_matched) & wcvp_status == "Accepted") %>%
  arrange(match_similarity)  %>%
  mutate(row_id = row_number())

# If genus, species or subspecies seem very different (not just spelling). It is probably a mistake
# If the error is a small spelling, leave the name in WCVP (accepted name)
# For the species that the match is weird, lets leave the current name as accepted name.
if(nrow(matchingerrors)>0){
  knitr::kable(matchingerrors %>% select(row_id, pbiota_name,Name_matched, Accepted_name, match_similarity), caption="The name is accepted but the spelling is a bit difference.")
}

```

```{r spellfix}
# list of species name that we will change as they have a different spelling
changes_spelling1 <- matchingerrors %>%
  filter(row_id %in% c(10, 13:19, 21:49)) %>%
  mutate(note = "Spelling changed") %>%
  select(pbiota_name, Accepted_name)

inc <- with(bcibiotawcvpplus, bcibiotawcvpplus$pbiota_name %in% changes_spelling1$pbiota_name)

species_modified1 <- bcibiotawcvpplus[inc,] %>% mutate(note = "Spelling changed")
if(nrow(species_modified1)>0){
  knitr::kable(species_modified1 %>% select( pbiota_name,Name_matched, Accepted_name, match_similarity), caption="Spelling errors to be corrected.")
}


if (any(inc, na.rm=TRUE)) {
  
  tmp <- bcibiotawcvpplus[inc, ]
  
  # Perform calculations on the subset
  tmp$currpbiotachanged <- TRUE
  tmp$currwcvp_author     <- ifelse(!is.na(tmp$Accepted_name_author), tmp$Accepted_name_author, tmp$wcvp_author)
  tmp$synonyms        <- paste(tmp$synonyms, tmp$pbiota_name)
  tmp$currwcvp_family     <- ifelse(!is.na(tmp$Accepted_family), tmp$Accepted_family, tmp$wcvp_family)
  tmp$currwcvp_genus      <- tmp$Accepted_name_genus
  tmp$currwcvp_species    <- tmp$Accepted_name_species
  tmp$currwcvp_subspecies <- tmp$Accepted_name_infraspecies
  tmp$currwcvp_name       <- tmp$Accepted_name
  tmp$currnotes            <-"Spelling changed in wcvp"
  
  # Re-assign the modified subset back to the original rows
  bcibiotawcvpplus[inc, ] <- tmp
}
```

# Case when match is not perfect and species name has changed.
```{r noperfectchange}

# Some species have changed their name, that is normal. Lets check that wcvp didint make a mistake the matching
noacceptedwcvpname <- bcibiotawcvpplus %>% 
  filter(
    (is.na(wcvp_status) | wcvp_status != "Accepted") &
      !is.na(pbiota_name) &
      !is.na(Name_matched) &
      pbiota_name != Name_matched
  ) %>%
  arrange(wcvp_status, match_similarity) %>%
  mutate(row_id = row_number()) %>%
  select(row_id, pbiota_name, Name_matched, Accepted_name, wcvp_status, match_similarity) 

if(nrow(noacceptedwcvpname)>0){
  knitr::kable(noacceptedwcvpname, caption="Species where the match is not exact and the name changes")
}
```


```{r noperfechchangefix}
# If the matched name is very different needs revision
# otherwise its probably a spelling error, the accepted name is okay
change_name2 <- noacceptedwcvpname %>%
  filter(row_id %in% c(11:18)) %>%
  mutate(note = "Spelling changed. Accepted name changed") %>%
  select(pbiota_name, Accepted_name)

inc <- with(bcibiotawcvpplus, bcibiotawcvpplus$pbiota_name %in% change_name2$pbiota_name)

species_modified2 <- bcibiotawcvpplus[inc,] %>% mutate(note = "Spelling changed")

if(nrow(species_modified2)>0){
  knitr::kable(species_modified2 %>% select( pbiota_name,Name_matched, Accepted_name, match_similarity), caption="Keeping accepted name")
}


if (any(inc, na.rm=TRUE)) {
  
  tmp <- bcibiotawcvpplus[inc, ]
  
  # Perform calculations on the subset
  tmp$currpbiotachanged <- TRUE
  tmp$currwcvp_author     <- ifelse(!is.na(tmp$Accepted_name_author), tmp$Accepted_name_author, tmp$wcvp_author)
  tmp$synonyms        <- paste(tmp$synonyms, tmp$pbiota_name)
  tmp$currwcvp_family     <- ifelse(!is.na(tmp$Accepted_family), tmp$Accepted_family, tmp$wcvp_family)
  tmp$currwcvp_genus      <- tmp$Accepted_name_genus
  tmp$currwcvp_species    <- tmp$Accepted_name_species
  tmp$currwcvp_subspecies <- tmp$Accepted_name_infraspecies
  tmp$currwcvp_name       <- tmp$Accepted_name
  tmp$currnotes            <-"Spelling changed in wcvp"
  
  # Re-assign the modified subset back to the original rows
  bcibiotawcvpplus[inc, ] <- tmp
}

```

## Cases in which panamabiota species now have the same name under wcvp:
```{r twonames}
# Two species can now have the same accepted name. 
# One is now considered a synonym or illegitimate and the other is the accepted name

# OR the synonim could be a different species but with a matching error. Lets check. 

acceptednamesdup <- bcibiotawcvpplus %>% 
  filter(!is.na(Accepted_name) ) %>%
  group_by(Accepted_name) %>% 
  arrange(Accepted_name) %>% filter(n()>1) %>% ungroup() %>%
  arrange(match_similarity, Accepted_name) %>%
  mutate(row_id = row_number()) %>% 
  select(row_id, Accepted_name,pbiota_name, pbiota_name, Name_matched, wcvp_status, match_similarity )

if( nrow(acceptednamesdup) > 0){
  knitr::kable(acceptednamesdup %>% select(row_id, Accepted_name, pbiota_name, Name_matched, match_similarity ), caption="Two species have now the same name")
}

```


```{r twonamesfix}

# For this species we dont want the accepted name to change to the current name. Because we would loose information
# we will leave those unchanged. The reste change them
change_names_ <- acceptednamesdup %>% 
  filter(!row_id %in% c(1:2, 4:7, 10)) %>%
  select(pbiota_name, Accepted_name)

if( nrow(change_names_) > 0){
  knitr::kable(change_names_, caption="Species to remove because they have the same accepted name as another species.")
}


affected_accepted <- bcibiotawcvpplus %>%
  filter(pbiota_name %in% change_names_$pbiota_name) %>%
  pull(Accepted_name) %>%
  unique()

rmeovesp <- bcibiotawcvpplus %>% filter(pbiota_name %in% change_names_$pbiota_name)
rmeovesp$currnotes <- "Species panamabiota has now the same accepted name in wcvp as another species. Removed species"
removed_species <- rmeovesp

# remove the species that are now duplicated with the same accepted name. 
bcibiotawcvpplus <- bcibiotawcvpplus %>%
  group_by(Accepted_name) %>%
  mutate(
    synonyms = if_else(
      Accepted_name %in% affected_accepted & wcvp_status == "Accepted",
      paste(
        unique(pbiota_name[
          pbiota_name %in% change_names_$pbiota_name &
            wcvp_status != "Accepted"
        ]),
        collapse = "; "
      ),
      synonyms
    )
  ) %>%
  ungroup() %>%
  filter(!pbiota_name %in% change_names_$pbiota_name)

```



## Change species name when the match was perfect and WCVP reported a name change:
```{r seechamngenames}

# if for some reason species name change but should be left alone. 
leave_current_names = c(
  "Swartzia simplex var. continentalis", # no match with the subspecies
  "Swartzia simplex var. grandiflora"  # no match with the subspecies
)

species_accepted_changed <- bcibiotawcvpplus %>% filter(
        (!is.na(pbiota_name) & !is.na(Name_matched) & pbiota_name == Name_matched & wcvp_status != "Accepted") &
        (!is.na(pbiota_name) & !pbiota_name  %in% leave_current_names)
)
  

if(nrow(species_accepted_changed) > 0){
   knitr::kable(species_accepted_changed %>% select(pbiota_name, Name_matched, Accepted_name, wcvp_status), caption="Species name changed.")
}

```

```{r fixchangenames}

# Now the species names we would like to change:
# No missmatch between Name_matched and Current_name and The state is non accepted.

inc <- with(bcibiotawcvpplus,(
        (!is.na(pbiota_name) & !is.na(Name_matched) & pbiota_name == Name_matched & wcvp_status != "Accepted") &
        (!is.na(pbiota_name) & !pbiota_name  %in% leave_current_names)
        ))

species_modified4 <- bcibiotawcvpplus[inc,]

if (any(inc, na.rm=TRUE)) {
  
  tmp <- bcibiotawcvpplus[inc, ]
  
  # Perform calculations on the subset
  tmp$currpbiotachanged <- TRUE
  tmp$currwcvp_author     <- ifelse(!is.na(tmp$Accepted_name_author), tmp$Accepted_name_author, tmp$wcvp_authors)
  tmp$synonyms        <- paste(tmp$synonyms, tmp$pbiota_name)
  tmp$currwcvp_family     <- ifelse(!is.na(tmp$Accepted_family), tmp$Accepted_family, tmp$currwcvp_family)
  tmp$currwcvp_genus      <- tmp$Accepted_name_genus
  tmp$currwcvp_species    <- tmp$Accepted_name_species
  tmp$currwcvp_subspecies <- tmp$Accepted_name_infraspecies
  tmp$currwcvp_name       <- tmp$Accepted_name
  tmp$currnotes            <- paste0("Previous Species name was ", tmp$wcvp_status, " - Name changed in wcvp")
  
  # Re-assign the modified subset back to the original rows
  bcibiotawcvpplus[inc, ] <- tmp
}

```

## Summary of modifications
```{r summarymod}

species_modified <- bcibiotawcvpplus %>% filter( currpbiotachanged == TRUE) %>% arrange(currnotes, pbiota_name)


species_modified <- bind_rows(species_modified, removed_species)

paste0("Total of species modified: ",  nrow(species_modified))

if( nrow(species_modified) > 0){
  knitr::kable(species_modified %>%  select(pbiota_name, currwcvp_name, pbiota_family,  currwcvp_family,  wcvp_status, currnotes), caption="Species modified after matching with WCVP")
}


# Save modifications in a separate file:
write_xlsx(species_modified,paste0(save_plantlists_dir, "BCI_PLANTS_PANAMABIOTA_WCVP_changes_",Sys.Date(),".xlsx"))


# Porcentaje del cambio: 
(nrow(species_modified) / nrow(bcibiotawcvpplus) ) * 100

```

## Sanity check:  species were the name didint change and check duplicated species.

```{r}

# species that remain with a different name from wcvp
species_no_wcvp <- bcibiotawcvpplus %>% filter(is.na(currwcvp_name) | is.na(Accepted_name) | currwcvp_name!=Accepted_name)
#species_no_wcvp %>% select(sp6, forestgeo_name, currwcvp_name, Name_matched ,Accepted_name, currforestgeochanged)

paste0("Species were accepted name is still different from wcvp : ",  nrow(species_no_wcvp))
if( nrow(species_modified) > 0){
  knitr::kable(species_no_wcvp %>%  select(currwcvp_name, Name_matched, Accepted_name,  currwcvp_family, Accepted_family, wcvp_status, currnotes), caption="Species were name is still different from wcvp accepted name")
}


# species with duplicated accepted name
acceptednamesdup <- bcibiotawcvpplus %>% 
  filter(!is.na(currwcvp_name)) %>%
  group_by(currwcvp_name) %>% 
  arrange(currwcvp_name) %>% filter(n()>1) %>% ungroup() %>%
  mutate(mismatch = (pbiota_name != Name_matched)) %>% 
  arrange(currwcvp_name, mismatch, match_similarity) %>%
  select( currwcvp_name, pbiota_name, Name_matched, wcvp_status, mismatch, match_similarity )

if( nrow(acceptednamesdup) > 0){
  knitr::kable(acceptednamesdup,caption="Duplicated species")
}

```

### Species with missing information in some column

```{r missinginfo}
library(DT)
missing_info <- bcibiotawcvpplus %>% filter(
  (!is.na(currwcvp_name ) & word(currwcvp_name, 1) != currwcvp_genus) |
  is.na(currwcvp_genus) | is.na(currwcvp_family) | is.na(currwcvp_author) | is.na(currwcvp_species))   

datatable(
  missing_info %>% select( currwcvp_name, pbiota_name, 
         currwcvp_family,  pbiota_family, currwcvp_genus, currwcvp_species, currwcvp_author, 
         pbiota_author, Accepted_name_author, currpbiotachanged, wcvp_status, currnotes),
  caption = "Species with missing taxonomic information in wcvp",
  options = list(scrollX = TRUE, pageLength = 10),
  rownames = FALSE
)

```

## Save output with WCVP names of all PanamaBiota species.
```{r saveoutput}
# Remove some columns
outtaxa <- bcibiotawcvpplus %>%
  rename(
    wcvp_lifeform_description = lifeform_description
  ) %>%
  select(-Name_matched, -wcvp_authors, -Name_matched_rank, -Accepted_name,-wcvp_status, -Accepted_family,
         -Accepted_name_rank, -Accepted_name_author, -Accepted_name_status, -Accepted_name_genus,             
          -Accepted_name_species, -Accepted_name_infraspecific_rank, -Accepted_name_infraspecies,            
          -match_similarity, -match_edit_distance)


write_xlsx(outtaxa, paste0(save_plantlists_dir, "BCI_PLANTS_panamabiota_WCVP_",Sys.Date(),".xlsx"))
```

Saved `r nrow(outtaxa)` species in Panama Biota lists with their names verified with WCVP. 

## Finally, merge woody and BCI

```{r merging, echo=TRUE, results="hide"}

### MERGE WOODY AND BCI ##################################

bcibiotafix_clean <- outtaxa
# Left join woodypanama and bcibiota

# woody species that ARE in BCI
woodybci <- lastwoody %>%
  filter(currwcvp_name %in% bcibiotafix_clean$currwcvp_name)

nrow(woodybci)


write_xlsx(woodybci, paste0(save_plantlists_dir, "woody_in_panamabiota_bci_",Sys.Date(),".xlsx"))

# woody species NOT in BCI
woodynotbci <- lastwoody %>%
  filter(!currwcvp_name %in% bcibiotafix_clean$currwcvp_name)

nrow(woodynotbci)

write_xlsx(woodynotbci, paste0(save_plantlists_dir, "woody_not_in_panamabiota_bci_",Sys.Date(),".xlsx"))


# BCI species NOT in woody list
bcinotwoody <- bcibiotafix_clean %>%
  filter(!currwcvp_name %in% lastwoody$currwcvp_name,
         source != "ferns"
         )

write_xlsx(bcinotwoody, paste0(save_plantlists_dir, "panama_biota_bci_not_woody_",Sys.Date(),".xlsx"))


bcinotwoody %>% select(currwcvp_name, source, wcvp_lifeform_description)
nrow(bcinotwoody)


bcimaybewoody <- bcinotwoody %>%
  filter(wcvp_lifeform_description %in% unique(lastwoody$wcvp_lifeform_description))

write_xlsx(bcimaybewoody, paste0(save_plantlists_dir, "panama_biota_bci_maybe_woody_",Sys.Date(),".xlsx"))


# Function to reshape a list into 5 columns (filling vertically)
make_5_col_list <- function(df, col_name = "currwcvp_name") {
  vec <- df[[col_name]]
  n <- length(vec)
  cols <- 5
  rows <- ceiling(n / cols)
  
  # Pad with empty strings to make it divisible by 5
  vec_padded <- c(vec, rep("", (rows * cols) - n))
  
  # Create a matrix and fill by column
  mat <- matrix(vec_padded, nrow = rows, ncol = cols, byrow = FALSE)
  
  return(as.data.frame(mat))
}

make_5_col_list <- function(vec) {
  n <- length(vec)
  cols <- 5
  rows <- ceiling(n / cols)
  
  # Pad with empty strings to make it divisible by 5
  vec_padded <- c(vec, rep("", (rows * cols) - n))
  
  # Create a matrix and fill by column
  mat <- matrix(vec_padded, nrow = rows, ncol = cols, byrow = FALSE)
  
  return(as.data.frame(mat))
}
```

### Woody species in PanamaBiota BCI list: `r nrow(woodybci)`
```{r}
if(nrow(woodybci) > 0){
  woodybci$currwcvp_name %>% 
    make_5_col_list() %>% 
    knitr::kable(col.names = NULL, caption="Panama Woody species in PanamBiota BCI list")
}
```


### Woody species NOT in PanamaBiota BCI list: `r nrow(woodynotbci)`
```{r}

woody_families_not_bci <- unique(woodynotbci %>% filter(!currwcvp_family %in% bcibiotafix_clean$currwcvp_family) %>% select(currwcvp_family) )

# since they are to many just print the families
if(nrow(woody_families_not_bci) > 0){
    woody_families_not_bci %>% 
    make_5_col_list() %>% 
    knitr::kable(col.names = NULL, caption="Panama woody families that are not in the BCI list")
}
```


### Species in PanamaBiota BCI list not in Panama Woody list: `r nrow(bcinotwoody)`


### Species that might be woody and are in BCI Panama Biota list: `r nrow(bcimaybewoody)`
```{r}
if(nrow(bcimaybewoody) > 0){
  bcimaybewoody$currwcvp_name %>% 
    make_5_col_list() %>% 
    knitr::kable(col.names = NULL, caption="BCI species that might be woody per WCVP")
}
```


```{r snaity2}


# How do we verify that no species is being missed?

```
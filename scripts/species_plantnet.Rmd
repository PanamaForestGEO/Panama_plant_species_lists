---
title: "species_plantnet"
author: "Helene Muller-Landau, Paula Uzcategui"
date: "2026-02-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Create a combined BCI species list

Using three sources: garwood list (2009), zotz list, and panama biota list. 

We match the names by the wcvp accepted name, if its not in any of the other lists it is added as a new row. The original name of the species in each list is preserved, as well as the wcvp_matched_name. 

OUTPUTS: 

- list of BCI panama plant species

- list of Zotz species that are not in any way in Garwood (synonym, Croat name, original name, matched name)

- list of PanamaBiota species that are not in any way in Garwood (synonym, original name, matched name)

- list of BCI species that might be woody according to the wcvp lifeform (needs revision)

```{r setup2, echo=TRUE,message=FALSE, warning=FALSE, results="hide"}

rm(list=ls())

library("readxl")
library("writexl")
library("dplyr")
library(tidyr)
library("stringi")
library("stringr")
library(DT)
```

# Preparing the datasets

```{r prep, echo=TRUE, results="hide"}

save_plantlists_dir = "splists_out/Plantnet species/"

pbiota_list <- read_excel("splists_out/PanamaBiotaBCI_WCVP_2026-02-25.xlsx", col_types = c("text", "text", "text", "text",  rep("guess", 20)))


garwood_list <- read_excel("splists_out/Garwood_2009_Appendix1HM2_WCVP_2026-02-25.xlsx")

zotz_list <- read_excel("splists_out/83_Zotz_Epiphytes_TableS1_WCVP_2026-02-25.xlsx")

woody_list <- read_excel("splists_out/CurrentPanamaWoody_2026-02-22.xlsx",
                         col_types = "text")

woody_synonyms <- read_excel("splists_out/CurrentPanamaWoody_SYNONYMS_2026-02-22.xlsx")
garwood_synonyms <- read_excel("splists_raw/Garwood/Garwood_2009_Appendix1_Synonyms.xlsx") 


garwood_synonyms <- garwood_synonyms %>% mutate(
  sp_name = trimws(paste0(Genus, " ", Species)),
  synonym_sp = trimws(paste0(SynonymGenusSingle, " ", SynonymSpeciesSingle)))

```
## BCI LIST

### Zotz list
```{r zotzlist, echo=TRUE}

# 1. see match wcvp names
match_wcvp <- match(zotz_list$wcvp_accepted_name, garwood_list$wcvp_accepted_name)
# Remove matches where BOTH are NA
match_wcvp <- ifelse(is.na(zotz_list$wcvp_accepted_name), NA, match_wcvp)
zotz_no_wcvp <- zotz_list %>% filter(is.na(match_wcvp))


datatable(zotz_no_wcvp %>% select(orig_name, wcvp_matched_name, wcvp_accepted_name, `Sp (Croat 1978)`),
          caption="Zotz wcvp accepted names that are not in garwood wcvp accepted names"
          )

```

### Zotz species that are not in garwood
```{r zotznogarwood}

# species that are somewhere in garwood
zotz_garwood_match <-  zotz_list %>% filter(
  
  orig_name %in% garwood_list$orig_name | 
  (!is.na(wcvp_matched_name) & wcvp_matched_name %in% garwood_list$wcvp_matched_name) | 
  (!is.na(wcvp_accepted_name) & wcvp_accepted_name %in% garwood_list$wcvp_accepted_name) |
  
  # Croat names are the original names used to build garwood
  `Sp (Croat 1978)` %in% garwood_list$orig_name | 
  `Sp (Croat 1978)` %in% garwood_list$wcvp_matched_name | 
  `Sp (Croat 1978)` %in% garwood_list$wcvp_accepted_name |
  
  # match to garwood synonyms
  orig_name %in% garwood_synonyms$synonym_sp |
  (!is.na(wcvp_matched_name) & wcvp_matched_name %in% garwood_synonyms$synonym_sp) |
  (!is.na(wcvp_accepted_name) & wcvp_accepted_name %in% garwood_synonyms$synonym_sp) |
  `Sp (Croat 1978)` %in% garwood_synonyms$synonym_sp  
  ) 

zotz_no_garwood_at_all <- subset(zotz_list, !orig_name %in% zotz_garwood_match$orig_name) %>% select(orig_name, wcvp_matched_name, wcvp_accepted_name, `Sp (Croat 1978)`)

zotz_no_wcvp <- zotz_no_wcvp %>% mutate(
  any_garwood_match = orig_name %in% zotz_garwood_match$orig_name
)

datatable(zotz_no_garwood_at_all, options = list(scrollX = TRUE, pageLength = 10))

write_xlsx(zotz_no_garwood_at_all, "splists_out/zotz_species_not_in_garwood.xlsx")

```
Note that the accepted name might not be in garwood. But the croat name is in a garwood column.

Add to bci list
```{r}
# using garwood as a base
garwood_list$source_list = "Garwood2009"
zotz_no_wcvp$source_list = "Zotz"

listscol <- c("orig_name","wcvp_matched_name", "wcvp_accepted_name","wcvp_accepted_family", "wcvp_accepted_author", "wcvp_lifeform_description", "wcvp_accepted_id",  "wcvp_matched_status", "wcvp_lifeform_description", "source_list")

bcilist <- bind_rows(
  garwood_list %>% 
    select(all_of(c(listscol, "SYNONYMS"))),
  zotz_no_wcvp %>% select(all_of(c(listscol, "any_garwood_match")))
)

```


### Panama biota list
```{r panamabiotabcilist, echo=TRUE}

# 1. see match by  wcvp names
match_wcvp <- match(pbiota_list$wcvp_accepted_name, bcilist$wcvp_accepted_name)
# Remove matches where BOTH are NA
match_wcvp <- ifelse(is.na(pbiota_list$wcvp_accepted_name), NA, match_wcvp)
pbiota_no_wcvp <- pbiota_list %>% filter(is.na(match_wcvp))



datatable(pbiota_no_wcvp %>% select(orig_name, wcvp_matched_name, wcvp_accepted_name),
          caption="Pbiota species wcvp accepted name is not in garwood or zotz wcvp accepted names",
          options = list(scrollX = TRUE, pageLength = 10)
          )
```

### Panamabiota species that are not in garwood
```{r pbiotanogarwood}

pbiota_garwood_match <- pbiota_list %>% filter(
  orig_name %in% garwood_list$orig_name | 
  (!is.na(wcvp_matched_name) & wcvp_matched_name %in% garwood_list$wcvp_matched_name) | 
  (!is.na(wcvp_accepted_name) & wcvp_accepted_name %in% garwood_list$wcvp_accepted_name) |
 
  # match to garwood synonyms
  orig_name %in% garwood_synonyms$synonym_sp |
  (!is.na(wcvp_matched_name) & wcvp_matched_name %in% garwood_synonyms$synonym_sp) |
  (!is.na(wcvp_accepted_name) & wcvp_accepted_name %in%  garwood_synonyms$synonym_sp)
)


pbiota_no_garwood_at_all <- subset(pbiota_list,!orig_name %in% pbiota_garwood_match$orig_name) %>%
  select(orig_name, wcvp_matched_name, wcvp_accepted_name)


pbiota_no_wcvp <- pbiota_no_wcvp %>% mutate(
  any_garwood_match = orig_name %in% pbiota_garwood_match$orig_name
)


datatable(pbiota_no_garwood_at_all, options = list(scrollX = TRUE, pageLength = 10))

write_xlsx(pbiota_no_garwood_at_all, "splists_out/panamabiota_species_not_in_garwood.xlsx")

```

Add to bci list
```{r mergebci}

pbiota_no_wcvp$source_list = "PanamaBiota"
pbiota_no_wcvp <- pbiota_no_wcvp %>% select(all_of(c(listscol, "any_garwood_match")))

bcilist <- bind_rows(bcilist, pbiota_no_wcvp)

bcilist<- bcilist %>%
  left_join(
    garwood_synonyms %>% select(sp_orig = sp_name, synonym_sp, syn_orig = SynonymTextALL) %>% distinct(),
    by = c("orig_name" = "synonym_sp")
  ) %>%
  left_join(
    garwood_synonyms %>% select(sp_curr = sp_name, synonym_sp, syn_curr = SynonymTextALL) %>% distinct(),
    by = c("wcvp_accepted_name" = "synonym_sp"), relationship = "many-to-many") %>%
  mutate(
    SynonymTextALL = coalesce(syn_orig, syn_curr),
    orig_garwood = coalesce(sp_orig, sp_curr)
  ) %>%
  select(-syn_orig, -syn_curr, -sp_orig, -sp_curr) %>%
  distinct(wcvp_accepted_name, orig_name, .keep_all = TRUE)
 
```

```{r printresult}

datatable(
  bcilist %>%
    select(wcvp_accepted_name, orig_name, source_list, any_garwood_match) %>% 
    arrange(source_list),
    caption="Species list in BCI and their source",
  options = list(scrollX = TRUE, pageLength = 10))

```

## Add woody species column
 
If the species is in the woody list

```{r bcilistwoody, echo=TRUE, results="hide"}
# set woody if:
# original, matched or accepted name is anywhere in woody list

bcilist <- bcilist %>% mutate(
  woody_name =  wcvp_accepted_name %in% woody_list$current_name | 
                wcvp_accepted_name %in% woody_list$forestgeo_name | 
                wcvp_matched_name %in% woody_list$current_name |
                wcvp_matched_name %in% woody_list$forestgeo_name |
                orig_name %in% woody_list$forestgeo_name |
                orig_name %in% woody_list$current_name,
  woody_synonym =  wcvp_accepted_name %in% woody_synonyms$SynonymTextSingle |
                   orig_name %in% woody_synonyms$SynonymTextSingle |
                   wcvp_matched_name %in% woody_synonyms$SynonymTextSingle,
  woody = woody_name | woody_synonym
) 

write_xlsx(bcilist, paste0(save_plantlists_dir, "BCI_SPECIES_LIST_",Sys.Date(),".xlsx"))


```

### Possibly woody species

```{r posiblywoody, echo=TRUE, results="hide"}

lifeform_woody = c(
  "tree",
  "shrub",
  "liana",
  "climbing shrub",
  "shrub or tree",
  "climbing shrub or tree",
  "scrambling shrub or tree",
  "subshrub or shrub",
  "subshrub, shrub or tree",
  "scrambling shrub",
  "perennial or shrub",
  "scrambling subshrub or shrub",
  "epiphytic shrub",
  "scrambling tree",
  "climbing shrub or liana",
  "scrambling shrub or liana",
  "tuberous shrub or tree",
  "herbaceous tree",
  "climbing herbaceous tree",
  "climbing herbaceous tree or liana",
  "climbing perennial or herbaceous tree",
  "subshrub or climbing shrub",
  "tuberous subshrub",
  "hemiparasitic shrub",
  "hemiepiphytic shrub or tree",
  "annual or shrub",
  "annual, subshrub or shrub"
)

bcilist_possibly_woody <- bcilist %>%
  filter(!woody &
          wcvp_lifeform_description %in% lifeform_woody ) %>%
  select(orig_name, wcvp_matched_name, wcvp_accepted_name, wcvp_accepted_family, wcvp_lifeform_description)


write_xlsx(bcilist_possibly_woody, paste0(save_plantlists_dir, "BCI_SPECIES_LIST_POSSIBLY_WOODY_",Sys.Date(),".xlsx"))


```


# Woody species

```{r woodylist, results="hide", echo=TRUE}


forestgeo_regional_list <- read_excel("splists_raw/Forestgeo/2025-12-04FromSuzanne/ViewTaxonomy_dec4_25.xlsx")

# Column of forestgeo regional list
sum(is.na(forestgeo_regional_list$Mnemonic))

match12 <- match(woody_list$sp6, forestgeo_regional_list$Mnemonic)            

woody_list[is.na(match12),] %>% select(sp6, current_name , forestgeo_name)

match21 <- match(forestgeo_regional_list$Mnemonic, woody_list$sp6)            

nomatchview <- forestgeo_regional_list[is.na(match21),] %>% select(Mnemonic, SpeciesName)
#almost everything that didint match is unidentified
#nomatchview$SpeciesName


### add column if its in the plots
abundall <- read_excel("splists_raw/Plots/abundance_plots_HM.xlsx")

abundall <- abundall %>% select(sp, binomial, bci, `bci 10 ha plot`,P14, P11)%>% 
  filter( bci >0 | `bci 10 ha plot` > 0 | P14 > 0| P11 >0)

match21 <- match(abundall$sp, woody_list$sp6)            
nomatchview <- abundall[is.na(match21),] %>% select(sp, binomial)

plotbci_list <- abundall %>% filter(bci >0)
plotbci10ha_list <- abundall %>% filter(`bci 10 ha plot`  >0)
plotp14_list <- abundall %>% filter(P14 >0)
plotp11_list <- abundall %>% filter(P11 >0)


woody_list <- woody_list %>% rename(
  wcvp_accepted_name = current_name,
  wcvp_matched_name = wcvp_Name_matched,
  orig_name = forestgeo_name
)
### Add columns ####

woody_list <- woody_list %>% mutate(
  forestgeo_regional = sp6 %in% forestgeo_regional_list$Mnemonic,
  plotbci = sp6 %in% plotbci_list$sp,
  plotbci10 = sp6 %in% plotbci10ha_list$sp,
  plotp14 = sp6 %in% plotp14_list$sp,
  plotp11 = sp6 %in% plotp11_list$sp,
  bci_accepted = wcvp_accepted_name %in% bcilist$wcvp_accepted_name |
                 wcvp_accepted_name %in% bcilist$wcvp_matched_name |
                 wcvp_accepted_name %in% bcilist$orig_name,
  bci_matched = wcvp_matched_name %in% bcilist$wcvp_accepted_name |
                wcvp_matched_name %in% bcilist$wcvp_matched_name |
                wcvp_matched_name %in% bcilist$orig_name,
  bci_orig = orig_name %in% bcilist$wcvp_accepted_name |
             orig_name %in% bcilist$wcvp_matched_name |
             orig_name %in% bcilist$orig_name,
  bci_list  = bci_accepted | bci_matched | bci_orig,
  bci = bci_list | plotbci | plotbci10 | plotp14 | plotp11
)
#################### save new woody species list: 

write_xlsx(woody_list, paste0(save_plantlists_dir, "WOODY_SPECIES_",Sys.Date(),".xlsx"))

```



### Woody species that are NOT in garwood, zotz or panama biota but they are in BCI plots

```{r sanitycheck_bci, fig.width=10}

# How do we verify that no species is being missed?

# print species NOT in panama biota but they are in the plots
plotmatch <- woody_list %>% filter(!bci_list & bci) %>% select(wcvp_accepted_name, orig_name, forestgeo_synonyms, plotbci, plotbci10, plotp11, plotp11)


datatable(plotmatch, 
          caption="Woody species that dont match with any name in  BCI List (garwood, zotz, panamabiota) but have been reported in bci plots")
```

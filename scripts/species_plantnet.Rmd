---
title: "species_plantnet"
author: "Paula Uzcategui"
date: "2026-02-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Create a combined BCI species list

Using three sources: garwood list (2009), zotz list, and panama biota list. 

We match the names by the wcvp accepted name, if its not in any of the other lists it is added as a new row. The original name of the species in each list is preserved, as well as the wcvp_matched_name. 

OUTPUTS: 

- list of BCI panama plant species

- list of Zotz species that are not in any way in Garwood (synonym, Croat name, original name, matched name)

- list of PanamaBiota species that are not in any way in Garwood (synonym, original name, matched name)

- list of BCI species that might be woody according to the wcvp lifeform

```{r setup2, echo=TRUE,message=FALSE, warning=FALSE, results="hide"}

rm(list=ls())

library("readxl")
library("writexl")
library("dplyr")
library(tidyr)
library("stringi")
library("stringr")
library(DT)
```

# Preparing the datasets

```{r prep, echo=TRUE, results="hide"}

save_plantlists_dir = "splists_out/Plantnet species/"

pbiota_list <- read_excel("splists_out/PanamaBiotaBCI_WCVP_2026-02-25.xlsx", col_types = c("text", "text", "text", "text",  rep("guess", 20)))


garwood_list <- read_excel("splists_out/Garwood_2009_Appendix1HM2_WCVP_2026-02-25.xlsx")

zotz_list <- read_excel("splists_out/83_Zotz_Epiphytes_TableS1_WCVP_2026-02-25.xlsx")

woody_list <- read_excel("splists_out/CurrentPanamaWoody_2026-02-22.xlsx",
                         col_types = "text")

woody_synonyms <- read_excel("splists_out/CurrentPanamaWoody_SYNONYMS_2026-02-22.xlsx")
garwood_synonyms <- read_excel("splists_raw/Garwood/Garwood_2009_Appendix1_Synonyms.xlsx") 


garwood_synonyms <- garwood_synonyms %>% mutate(
  sp_name = trimws(paste0(Genus, " ", Species)),
  synonym_sp = trimws(paste0(SynonymGenusSingle, " ", SynonymSpeciesSingle)))

```
## BCI LIST

### Zotz list
```{r zotzlist, echo=TRUE, results="hide"}

# 1. see match wcvp names
match_wcvp <- match(zotz_list$wcvp_accepted_name, garwood_list$wcvp_accepted_name)
# Remove matches where BOTH are NA
match_wcvp <- ifelse(is.na(zotz_list$wcvp_accepted_name), NA, match_wcvp)
zotz_no_wcvp <- zotz_list %>% filter(is.na(match_wcvp))

# 2. add a column for synonym presence
zotz_no_wcvp <- zotz_no_wcvp %>%
  mutate(is_garwood_synonym = orig_name %in% garwood_synonyms$synonym_sp | wcvp_accepted_name %in% garwood_synonyms$synonym_sp | wcvp_matched_name %in% garwood_synonyms$synonym_sp |
             `Sp (Croat 1978)` %in% garwood_synonyms$synonym_sp 
         )

datatable(zotz_no_wcvp %>% select(orig_name, wcvp_matched_name, wcvp_accepted_name, is_garwood_synonym, `Sp (Croat 1978)`),
          caption="Zotz species that are not in garwood"
          )

```

### Zotz species that are not in garwood
```{r zotznogarwood}

zotz_no_garwood_at_all <- zotz_no_wcvp %>% filter(
  (!is.na(orig_name) & !orig_name %in% garwood_list$orig_name) & 
  (!is.na(wcvp_matched_name) | !wcvp_matched_name %in% garwood_list$wcvp_matched_name) & 
  (!is.na(wcvp_accepted_name) | !wcvp_accepted_name %in% garwood_list$wcvp_accepted_name) &
  (!`Sp (Croat 1978)` %in% garwood_synonyms$synonym_sp) & 
  (!`Sp (Croat 1978)` %in% garwood_list$orig_name) & 
  (!`Sp (Croat 1978)` %in% garwood_list$wcvp_matched_name) & 
  (!is.na(`Sp (Croat 1978)`) & !`Sp (Croat 1978)` %in% garwood_list$wcvp_accepted_name) &
  !is_garwood_synonym
  ) %>%
  select(orig_name, wcvp_matched_name, wcvp_accepted_name, `Sp (Croat 1978)`, is_garwood_synonym)


datatable(zotz_no_garwood_at_all, options = list(scrollX = TRUE, pageLength = 10))

write_xlsx(zotz_no_garwood_at_all, "splists_out/zotz_species_not_in_garwood.xlsx")

```
Note that the accepted name might not be in garwood. But the croat name is in a garwood column.

Add to bci list
```{r}
# using garwood as a base
garwood_list$source_list = "Garwood2009"
zotz_no_wcvp$source_list = "Zotz"

listscol <- c("orig_name","wcvp_matched_name", "wcvp_accepted_name","wcvp_accepted_family", "wcvp_accepted_author", "wcvp_lifeform_description", "wcvp_accepted_id",  "wcvp_matched_status", "wcvp_lifeform_description", "source_list")

bcilist <- bind_rows(
  garwood_list %>% 
    select(all_of(c(listscol, "SYNONYMS"))),
  zotz_no_wcvp %>% select(listscol, is_garwood_synonym)
)

```


### Panama biota list
```{r panamabiotabcilist, echo=TRUE, results="hide"}

# 1. see match by  wcvp names
match_wcvp <- match(pbiota_list$wcvp_accepted_name, bcilist$wcvp_accepted_name)
# Remove matches where BOTH are NA
match_wcvp <- ifelse(is.na(pbiota_list$wcvp_accepted_name), NA, match_wcvp)
pbiota_no_wcvp <- pbiota_list %>% filter(is.na(match_wcvp))


# 2. add field for synonym presence
pbiota_no_wcvp <- pbiota_no_wcvp %>%
  mutate(is_garwood_synonym = orig_name %in% garwood_synonyms$synonym_sp | wcvp_accepted_name %in%  garwood_synonyms$synonym_sp | wcvp_matched_name %in% garwood_synonyms$synonym_sp
           )

datatable(pbiota_no_wcvp %>% select(orig_name, wcvp_matched_name, wcvp_accepted_name, is_garwood_synonym),
          caption="Pbiota species that are not in garwood or zotz",
          options = list(scrollX = TRUE, pageLength = 10)
          )
```

### Panamabiota species that are not in garwood
```{r pbiotanogarwood}

pbiota_no_garwood_at_all <- pbiota_no_wcvp %>% filter(
  (!is.na(orig_name) & !orig_name %in% garwood_list$orig_name) & 
  (is.na(wcvp_matched_name) | !wcvp_matched_name %in% garwood_list$wcvp_matched_name) & 
  (is.na(wcvp_accepted_name) | !wcvp_accepted_name %in% garwood_list$wcvp_accepted_name) &
  !is_garwood_synonym
  ) %>%
  select(orig_name, wcvp_matched_name, wcvp_accepted_name, is_garwood_synonym)

datatable(pbiota_no_garwood_at_all, options = list(scrollX = TRUE, pageLength = 10))

write_xlsx(pbiota_no_garwood_at_all, "splists_out/panamabiota_species_not_in_garwood.xlsx")

```

Add to bci list
```{r mergebci}

pbiota_no_wcvp$source_list = "PanamaBiota"
pbiota_no_wcvp <- pbiota_no_wcvp %>% select(listscol, is_garwood_synonym)

bcilist <- bind_rows(bcilist, pbiota_no_wcvp)

bcilist <- bcilist %>% mutate(
  zotz = wcvp_accepted_name %in% zotz_list$wcvp_accepted_name | orig_name %in% zotz_list$orig_name,
  garwood =  wcvp_accepted_name %in% garwood_list$wcvp_accepted_name | orig_name %in% garwood_list$orig_name,
  panamabiota = wcvp_accepted_name %in% pbiota_list$wcvp_accepted_name | orig_name %in% pbiota_list$orig_name,
)

bcilist<- bcilist %>%
  left_join(
    garwood_synonyms %>% select(sp_orig = sp_name, synonym_sp, syn_orig = SynonymTextALL) %>% distinct(),
    by = c("orig_name" = "synonym_sp")
  ) %>%
  left_join(
    garwood_synonyms %>% select(sp_curr = sp_name, synonym_sp, syn_curr = SynonymTextALL) %>% distinct(),
    by = c("wcvp_accepted_name" = "synonym_sp"), relationship = "many-to-many") %>%
  mutate(
    SynonymTextALL = coalesce(syn_orig, syn_curr),
    orig_garwood = coalesce(sp_orig, sp_curr)
  ) %>%
  select(-syn_orig, -syn_curr, -sp_orig, -sp_curr) %>%
  distinct(wcvp_accepted_name, orig_name, .keep_all = TRUE)
 

datatable(
  bcilist %>% filter(!garwood & panamabiota & zotz) %>%
    select(wcvp_accepted_name, orig_name, source_list,zotz, garwood, panamabiota, is_garwood_synonym,orig_garwood, SynonymTextALL ) %>% 
    arrange(source_list),
    caption="Species wcvp accepted names are in zotz and panama biota but not in garwood",
  options = list(scrollX = TRUE, pageLength = 10),
  )

```

```{r printresult}

datatable(
  bcilist %>%
    select(wcvp_accepted_name, orig_name, source_list,zotz, garwood, panamabiota) %>% 
    arrange(source_list),
    caption="Species list in BCI and their source",
  options = list(scrollX = TRUE, pageLength = 10))

```

## Add woody species column
 
If the species is in the woody list

```{r bcilistwoody, echo=TRUE, results="hide"}
# set woody if:
# original, matched or accepted nam is anywhere in woody list

bcilist <- bcilist %>% mutate(
  woody_name =  wcvp_accepted_name %in% woody_list$current_name | 
                wcvp_accepted_name %in% woody_list$forestgeo_name | 
                wcvp_matched_name %in% woody_list$current_name |
                wcvp_matched_name %in% woody_list$forestgeo_name |
                orig_name %in% woody_list$forestgeo_name |
                orig_name %in% woody_list$current_name,
  woody_synonym =  wcvp_accepted_name %in% woody_synonyms$SynonymTextSingle 
                  | orig_name %in% woody_synonyms$SynonymTextSingle, 
  woody = woody_name | woody_synonym
) 

write_xlsx(bcilist, paste0(save_plantlists_dir, "BCI_SPECIES_LIST_",Sys.Date(),".xlsx"))


```

### Possibly woody species

```{r posiblywoody, echo=TRUE, results="hide"}

lifeform_woody = c(
  "tree",
  "shrub",
  "liana",
  "climbing shrub",
  "shrub or tree",
  "climbing shrub or tree",
  "scrambling shrub or tree",
  "subshrub or shrub",
  "subshrub, shrub or tree",
  "scrambling shrub",
  "perennial or shrub",
  "scrambling subshrub or shrub",
  "epiphytic shrub",
  "scrambling tree",
  "climbing shrub or liana",
  "scrambling shrub or liana",
  "tuberous shrub or tree",
  "herbaceous tree",
  "climbing herbaceous tree",
  "climbing herbaceous tree or liana",
  "climbing perennial or herbaceous tree",
  "subshrub or climbing shrub",
  "tuberous subshrub",
  "hemiparasitic shrub",
  "hemiepiphytic shrub or tree",
  "annual or shrub",
  "annual, subshrub or shrub"
)

bcilist_possibly_woody <- bcilist %>%
  filter(!woody &
          wcvp_lifeform_description %in% lifeform_woody ) %>%
  select(orig_name, wcvp_matched_name, wcvp_accepted_name, wcvp_accepted_family, wcvp_lifeform_description)


write_xlsx(bcilist_possibly_woody, paste0(save_plantlists_dir, "BCI_SPECIES_LIST_POSSIBLY_WOODY_",Sys.Date(),".xlsx"))


```


# Woody species

TODO
